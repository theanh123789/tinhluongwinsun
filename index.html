<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ch·∫•m c√¥ng & t√≠nh l∆∞∆°ng Winsun (N·ªôi b·ªô)</title>

  <style>
    :root{
      --bg:#f2f4f7; --card:#fff; --line:#e5e7eb;
      --text:#0f172a; --muted:#64748b;
      --primary:#2563eb; --success:#16a34a;
      --danger:#dc2626; --gray:#6b7280;
      --shadow: 0 10px 22px rgba(2,6,23,.08);
      --radius: 14px;
    }
    *{ box-sizing:border-box; }
    body{ font-family: Arial, sans-serif; background:var(--bg); padding:14px; margin:0; color:var(--text); }
    .container{
      background:var(--card);
      padding:14px;
      border-radius:var(--radius);
      max-width:1200px;
      margin:0 auto;
      box-shadow:var(--shadow);
      border:1px solid var(--line);
      transition: transform .2s ease, box-shadow .2s ease;
    }
    h2{ margin:0 0 10px; font-size:18px; }

    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    input, select, button{
      padding:10px 12px;
      border-radius:12px;
      border:1px solid var(--line);
      background:#fff;
      font-size:14px;
    }
    input:focus, select:focus{
      outline:none;
      border-color: rgba(37,99,235,.55);
      box-shadow: 0 0 0 4px rgba(37,99,235,.12);
    }

    button{
      border:none;
      cursor:pointer;
      color:#fff;
      background:var(--primary);
      font-weight:700;
      border-radius:12px;
      transition: transform .12s ease, filter .12s ease, box-shadow .12s ease;
    }
    button:hover{ filter: brightness(1.05); }
    button:active{ transform: scale(.98); }
    button.gray{ background:var(--gray); }
    button.danger{ background:var(--danger); }

    .muted{ color:var(--muted); font-size:13px; }
    .box{
      border:1px solid var(--line);
      border-radius:var(--radius);
      padding:12px;
      background:#fafafa;
      transition: transform .18s ease, box-shadow .18s ease, border-color .18s ease;
    }
    .box:hover{
      transform: translateY(-1px);
      box-shadow: 0 14px 28px rgba(2,6,23,.10);
      border-color: rgba(37,99,235,.25);
    }
    .spacer{ height:10px; }

    /* Tabs */
    .tabs{ display:flex; gap:8px; flex-wrap:wrap; margin-top:10px; }
    .tabs button{
      background:#fff;
      color:var(--text);
      border:1px solid var(--line);
      font-weight:800;
      transition: transform .15s ease, background .2s ease, color .2s ease, box-shadow .2s ease;
    }
    .tabs button:hover{
      transform: translateY(-1px);
      box-shadow: 0 10px 22px rgba(2,6,23,.10);
    }
    .tabs button.active{
      background:var(--success);
      color:#fff;
      border:none;
      box-shadow: 0 10px 24px rgba(22,163,74,.25);
    }

    /* Tables */
    .table-wrap{
      overflow-x:auto;
      border:1px solid var(--line);
      border-radius:var(--radius);
      background:#fff;
    }
    table{ width:100%; border-collapse:collapse; min-width:980px; background:#fff; }
    th, td{
      border-bottom:1px solid var(--line);
      padding:10px 8px;
      text-align:center;
      white-space:nowrap;
      font-size:13px;
    }
    th{ background:#f8fafc; position:sticky; top:0; z-index:1; }
    tr td{ transition: background .15s ease; }
    tr:hover td{ background:#f8fafc; }
    .total td{ font-weight:900; background:#ecfdf5; }

    /* Flash OK */
    .flash-ok{ animation: flashOk .55s ease; }
    @keyframes flashOk{
      0%{ box-shadow: 0 0 0 0 rgba(22,163,74,.0); }
      40%{ box-shadow: 0 0 0 8px rgba(22,163,74,.18); }
      100%{ box-shadow: 0 0 0 0 rgba(22,163,74,.0); }
    }

    /* Shake */
    .shake{ animation: shake .25s linear; }
    @keyframes shake{
      0%{ transform: translateX(0); }
      25%{ transform: translateX(-5px); }
      50%{ transform: translateX(5px); }
      75%{ transform: translateX(-4px); }
      100%{ transform: translateX(0); }
    }

    /* Fade out row */
    .fade-out{ animation: fadeOut .25s ease forwards; }
    @keyframes fadeOut{ to{ opacity:0; transform: translateX(6px); } }

    /* Toast */
    .toast{
      position: fixed;
      left: 50%;
      bottom: 92px;
      transform: translateX(-50%) translateY(10px);
      background: rgba(15,23,42,.92);
      color: #fff;
      padding: 10px 14px;
      border-radius: 999px;
      font-weight: 800;
      font-size: 13px;
      opacity: 0;
      pointer-events: none;
      transition: opacity .18s ease, transform .18s ease;
      z-index: 999;
    }
    .toast.show{ opacity: 1; transform: translateX(-50%) translateY(0); }

    /* Mobile */
    @media (max-width: 768px){
      body{ padding:10px; }
      .container{ padding:12px; margin-bottom: 92px; }
      .row{ flex-direction:column; align-items:stretch; }
      input, select, button{ width:100%; font-size:16px; padding:12px 14px; }

      .tabs{
        position:fixed;
        left:10px; right:10px; bottom:10px;
        background: rgba(255,255,255,.95);
        border:1px solid var(--line);
        border-radius:16px;
        padding:8px;
        box-shadow: var(--shadow);
        z-index:50;
      }
      .tabs button{ flex:1; width:auto; padding:12px 10px; font-size:14px; }
    }
  </style>
</head>

<body>
<script>
  // ====== PASSWORD GATE ======
  const PASSWORD = "Theanh@408"; // ƒë·ªïi m·∫≠t kh·∫©u t·∫°i ƒë√¢y
  if (localStorage.getItem("auth") !== "ok") {
    const p = prompt("Nh·∫≠p m·∫≠t kh·∫©u truy c·∫≠p:");
    if (p !== PASSWORD) {
      alert("Sai m·∫≠t kh·∫©u");
      document.body.innerHTML = "";
    } else {
      localStorage.setItem("auth", "ok");
    }
  }
</script>

<div class="container">
  <h2>üîê CH·∫§M C√îNG & T√çNH L∆Ø∆†NG WINSUN (N·ªòI B·ªò)</h2>

  <div class="row">
    <input id="workerName" placeholder="Nh·∫≠p t√™n c√¥ng nh√¢n" />
    <button onclick="addWorker()">‚ûï T·∫°o c√¥ng nh√¢n</button>
    <button class="gray" onclick="logout()">ƒêƒÉng xu·∫•t</button>
    <span class="muted">M·∫≠t kh·∫©u: <b>Theanh@408</b></span>
  </div>

  <div class="tabs" id="mainTabs">
    <button class="active" onclick="showTab('salary', event)">üí∞ T√≠nh l∆∞∆°ng</button>
    <button onclick="showTab('history', event)">üìú L·ªãch s·ª≠</button>
    <button onclick="showTab('stat', event)">üìä Th·ªëng k√™</button>
  </div>

  <div class="spacer"></div>

  <!-- TAB: Salary -->
  <div id="tab-salary">
    <div class="box">
      <div class="row">
        <b>Danh s√°ch c√¥ng nh√¢n</b>
        <span class="muted">(M·ªói c√¥ng nh√¢n l√† 1 tab ri√™ng)</span>
      </div>
      <div class="row" id="workerTabs"></div>
    </div>

    <div class="spacer"></div>

    <div id="workArea" style="display:none;">
      <div class="box">
        <div class="row">
          <label>Ng√†y:</label>
          <input type="date" id="date" />

          <label>Lo·∫°i ng√†y:</label>
          <select id="dayType">
            <option value="thuong">Ng√†y th∆∞·ªùng</option>
            <option value="chunhat">Ch·ªß nh·∫≠t</option>
          </select>

          <label>Ca:</label>
          <select id="shiftType">
            <option value="ngay">Ca ng√†y</option>
            <option value="dem">Ca ƒë√™m</option>
          </select>

          <label>B·∫Øt ƒë·∫ßu:</label>
          <input type="time" id="start" value="08:00" />

          <label>K·∫øt th√∫c:</label>
          <input type="time" id="end" value="20:00" />

          <button onclick="addDay()">‚ûï Th√™m ng√†y</button>
        </div>

        <div class="muted">
          ‚Ä¢ Ngh·ªâ <b>1 ti·∫øng</b> t·∫°i <b>11:45</b> (ca ng√†y) v√† <b>23:45</b> (ca ƒë√™m).<br/>
          ‚Ä¢ Ca ƒë√™m qua ng√†y (vd 20:00 ‚Üí 08:00) t·ª± t√≠nh ƒë√∫ng.<br/>
          ‚Ä¢ H·ªó tr·ª£ <b>+10k</b> ch·ªâ khi <b>Ng√†y th∆∞·ªùng + Ca ng√†y + 08:00‚Üí20:00</b> v√† ƒë·ªß <b>11 gi·ªù l√†m</b> (sau ngh·ªâ).
        </div>
      </div>

      <div class="spacer"></div>

      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>Th·ª©</th>
              <th>Ng√†y</th>
              <th>B·∫Øt ƒë·∫ßu</th>
              <th>K·∫øt th√∫c</th>
              <th>M√£ CN</th>
              <th>HC</th>
              <th>TC</th>
              <th>H·ªó tr·ª£</th>
              <th>T·ªïng</th>
              <th>X√≥a</th>
            </tr>
          </thead>
          <tbody id="rows"></tbody>
          <tfoot>
            <tr class="total">
              <td colspan="5">T·ªîNG</td>
              <td id="tHC">0</td>
              <td id="tTC">0</td>
              <td id="tB">0</td>
              <td id="tSum">0</td>
              <td></td>
            </tr>
          </tfoot>
        </table>
      </div>
    </div>
  </div>

  <!-- TAB: History -->
  <div id="tab-history" style="display:none;">
    <h3>üìú L·ªãch s·ª≠ ghi c√¥ng h√¥m nay</h3>
    <div class="muted">Ch·ªâ hi·ªÉn th·ªã nh·ªØng d√≤ng ghi c√¥ng c√≥ <b>ng√†y = h√¥m nay</b>.</div>

    <div class="spacer"></div>

    <div class="table-wrap">
      <table style="min-width: 900px;">
        <thead>
          <tr>
            <th>Gi·ªù ghi</th>
            <th>Th·ª© - Ng√†y</th>
            <th>M√£ CN</th>
            <th>T√™n</th>
            <th>Ca</th>
            <th>B·∫Øt ƒë·∫ßu</th>
            <th>K·∫øt th√∫c</th>
          </tr>
        </thead>
        <tbody id="history"></tbody>
      </table>
    </div>
  </div>

  <!-- TAB: Stat -->
  <div id="tab-stat" style="display:none;">
    <h3>üìä Th·ªëng k√™</h3>

    <div class="box">
      <div class="row">
        <b>Theo ng√†y</b>
        <input type="date" id="statDate" />
        <button onclick="statDay()">Xem</button>
      </div>

      <div class="spacer"></div>

      <div class="row">
        <b>Theo tu·∫ßn (T2 ‚Üí CN)</b>
        <input type="date" id="statWeekPick" onchange="syncWeekRange()" />
        <span class="muted">T·ª´:</span>
        <input type="date" id="statWeekFrom" readonly />
        <span class="muted">ƒê·∫øn:</span>
        <input type="date" id="statWeekTo" readonly />
        <button onclick="statWeek()">Xem</button>
      </div>

      <div class="spacer"></div>

      <div class="row">
        <b>Theo th√°ng (ƒë·∫ßu ‚Üí cu·ªëi th√°ng)</b>
        <input type="date" id="statMonthPick" onchange="syncMonthRange()" />
        <span class="muted">T·ª´:</span>
        <input type="date" id="statMonthFrom" readonly />
        <span class="muted">ƒê·∫øn:</span>
        <input type="date" id="statMonthTo" readonly />
        <button onclick="statMonth()">Xem</button>
      </div>

      <div class="muted">
        ‚Ä¢ Ch·ªçn 1 ng√†y b·∫•t k·ª≥: tu·∫ßn t·ª± ra <b>T2‚ÜíCN</b>, th√°ng t·ª± ra <b>ƒë·∫ßu‚Üícu·ªëi th√°ng</b>.
      </div>
    </div>

    <div class="spacer"></div>

    <div class="table-wrap">
      <table style="min-width: 720px;">
        <thead>
          <tr>
            <th>ƒê·ªëi t∆∞·ª£ng</th>
            <th>HC</th>
            <th>TC</th>
            <th>H·ªó tr·ª£</th>
            <th>T·ªïng</th>
          </tr>
        </thead>
        <tbody id="statTable"></tbody>
      </table>
    </div>
  </div>
</div>

<div id="toast" class="toast">OK</div>

<script>
  // ========= Data =========
  let data = JSON.parse(localStorage.getItem("winsun")) || { workers: {}, history: [] };
  if (!data || typeof data !== "object") data = { workers: {}, history: [] };
  if (!data.workers) data.workers = {};
  if (!data.history) data.history = [];

  for (const id of Object.keys(data.workers)) {
    if (!data.workers[id]) data.workers[id] = { name: "(unknown)", days: [] };
    if (!data.workers[id].days) data.workers[id].days = [];
  }

  let current = null;

  function save(){ localStorage.setItem("winsun", JSON.stringify(data)); }
  function logout(){ localStorage.removeItem("auth"); location.reload(); }
  function toISO(d){ return d.toISOString().slice(0,10); }

  // ========= UI FX =========
  function showToast(msg){
    const t = document.getElementById("toast");
    t.textContent = msg;
    t.classList.add("show");
    clearTimeout(window.__toastTimer);
    window.__toastTimer = setTimeout(()=>t.classList.remove("show"), 1200);
  }
  function flashOk(){
    const box = document.querySelector("#workArea .box");
    if(!box) return;
    box.classList.remove("flash-ok");
    void box.offsetWidth;
    box.classList.add("flash-ok");
  }
  function shakeWorkArea(){
    const wa = document.getElementById("workArea");
    if(!wa) return;
    wa.classList.remove("shake");
    void wa.offsetWidth;
    wa.classList.add("shake");
  }

  // ========= Helpers =========
  function getThu(dateStr){
    const d = new Date(dateStr);
    const map = ["Ch·ªß nh·∫≠t","Th·ª© 2","Th·ª© 3","Th·ª© 4","Th·ª© 5","Th·ª© 6","Th·ª© 7"];
    return map[d.getDay()];
  }
  function parseTimeToMin(t){
    const [hh, mm] = t.split(":").map(Number);
    return (hh*60 + mm);
  }

  // ‚úÖ T√≠nh ph√∫t l√†m th·ª±c t·∫ø:
  // - ca ng√†y: ngh·ªâ 11:45 ‚Üí 12:45
  // - ca ƒë√™m: ngh·ªâ 23:45 ‚Üí 00:45
  // - ch·ªâ tr·ª´ n·∫øu ca l√†m c·∫Øt qua kho·∫£ng ngh·ªâ
  function calcWorkedMinutes(startStr, endStr, shiftType){
    const start = parseTimeToMin(startStr);
    let end = parseTimeToMin(endStr);
    if (end <= start) end += 1440; // qua ng√†y

    let breakStart = (shiftType === "dem") ? (23*60 + 45) : (11*60 + 45);
    let breakEnd = breakStart + 60;

    // ƒë∆∞a break v·ªÅ c√πng timeline v·ªõi ca
    if (breakStart < start) { breakStart += 1440; breakEnd += 1440; }

    const overlap = Math.max(0, Math.min(end, breakEnd) - Math.max(start, breakStart));
    const worked = (end - start) - overlap;
    return Math.max(0, worked);
  }

  function getWeekRange(dateStr){
    const d = new Date(dateStr);
    const day = d.getDay();
    const diff = (day === 0 ? -6 : 1) - day;
    const monday = new Date(d); monday.setDate(d.getDate()+diff);
    const sunday = new Date(monday); sunday.setDate(monday.getDate()+6);
    return { start: toISO(monday), end: toISO(sunday) };
  }
  function getMonthRange(dateStr){
    const d = new Date(dateStr);
    const start = new Date(d.getFullYear(), d.getMonth(), 1);
    const end = new Date(d.getFullYear(), d.getMonth()+1, 0);
    return { start: toISO(start), end: toISO(end) };
  }

  // ========= Tabs =========
  function showTab(tab, ev){
    document.getElementById("tab-salary").style.display = "none";
    document.getElementById("tab-history").style.display = "none";
    document.getElementById("tab-stat").style.display = "none";
    document.getElementById("tab-" + tab).style.display = "block";

    document.querySelectorAll("#mainTabs button").forEach(b => b.classList.remove("active"));
    if (ev && ev.target) ev.target.classList.add("active");
  }

  // ========= Workers =========
  function renderWorkerTabs(){
    const wrap = document.getElementById("workerTabs");
    wrap.innerHTML = "";

    const ids = Object.keys(data.workers);
    if (ids.length === 0){
      wrap.innerHTML = `<span class="muted">Ch∆∞a c√≥ c√¥ng nh√¢n. Nh·∫≠p t√™n v√† b·∫•m "T·∫°o c√¥ng nh√¢n".</span>`;
      document.getElementById("workArea").style.display = "none";
      current = null;
      return;
    }

    ids.forEach(id => {
      const btn = document.createElement("button");
      btn.className = (id === current) ? "" : "gray";
      btn.textContent = `${id} - ${data.workers[id].name}`;
      btn.onclick = () => selectWorker(id);
      wrap.appendChild(btn);
    });

    if (!current || !data.workers[current]) current = ids[0];
    document.getElementById("workArea").style.display = "block";
    loadWorker();
  }

  function addWorker(){
    const name = document.getElementById("workerName").value.trim();
    if (!name){
      showToast("Nh·∫≠p t√™n c√¥ng nh√¢n");
      shakeWorkArea();
      return;
    }

    if (Object.values(data.workers).some(w => (w?.name || "").toLowerCase() === name.toLowerCase())){
      showToast("T√™n ƒë√£ t·ªìn t·∫°i");
      shakeWorkArea();
      return;
    }

    const id = "CN" + String(Object.keys(data.workers).length + 1).padStart(3, "0");
    data.workers[id] = { name, days: [] };
    current = id;
    save();
    document.getElementById("workerName").value = "";
    renderWorkerTabs();
    showToast("‚úÖ ƒê√£ t·∫°o c√¥ng nh√¢n");
  }

  function selectWorker(id){
    current = id;
    loadWorker();
    renderWorkerTabs();
    showToast("ƒêang ch·ªçn " + id);
  }

  // ========= Add Day =========
  function addDay(){
    if (!current || !data.workers[current]) {
      showToast("Ch∆∞a ch·ªçn c√¥ng nh√¢n");
      shakeWorkArea();
      return;
    }

    const d = document.getElementById("date").value || toISO(new Date());
    const dayType = document.getElementById("dayType").value;     // thuong|chunhat
    const shiftType = document.getElementById("shiftType").value; // ngay|dem
    const sStr = document.getElementById("start").value || "08:00";
    const eStr = document.getElementById("end").value || "20:00";

    const workedMin = calcWorkedMinutes(sStr, eStr, shiftType);
    const workedHours = workedMin / 60;

    // rate theo b·∫£ng b·∫°n ch·ªët
    let hcRate = 0, tcRate = 0;
    if (dayType === "thuong"){
      hcRate = (shiftType === "ngay") ? 25000 : 30000;
      tcRate = (shiftType === "ngay") ? 30000 : 35000;
    } else {
      hcRate = (shiftType === "ngay") ? 35000 : 45000;
      tcRate = 0;
    }

    // HC t·ªëi ƒëa 8h, TC ph·∫ßn c√≤n l·∫°i
    const hcHours = Math.min(8, workedHours);
    const tcHours = Math.max(0, workedHours - 8);

    // pro-rate theo ph√∫t (l√†m l·∫ª ph√∫t v·∫´n ƒë√∫ng)
    const hc = Math.round(hcHours * hcRate);
    const tc = Math.round(tcHours * tcRate);

    // +10k: ng√†y th∆∞·ªùng + ca ng√†y + ƒë√∫ng 08:00 -> 20:00 + ƒë·ªß 11h (660 ph√∫t) sau ngh·ªâ
    const bonus = (dayType === "thuong" && shiftType === "ngay" && sStr === "08:00" && eStr === "20:00" && workedMin >= 660)
      ? 10000 : 0;

    const total = hc + tc + bonus;

    data.workers[current].days.push({
      d,
      thu: getThu(d),
      start: sStr,
      end: eStr,
      dayType,
      shiftType,
      workedMin,
      hc, tc, bonus, total
    });

    // history: ch·ªâ gi·ªØ h√¥m nay
    const today = toISO(new Date());
    data.history.unshift({
      time: new Date().toLocaleTimeString(),
      date: d, thu: getThu(d),
      id: current, name: data.workers[current].name,
      shift: shiftType, start: sStr, end: eStr
    });
    data.history = data.history.filter(x => x.date === today);

    save();
    loadWorker();
    renderHistory();

    flashOk();
    showToast("‚úÖ ƒê√£ th√™m ng√†y");
  }

  function loadWorker(){
    if (!current || !data.workers[current]) return;

    const days = data.workers[current].days || [];
    let html = "", sHC=0, sTC=0, sB=0, sT=0;

    days.forEach((x,i) => {
      const d = x.d || "";
      const thu = x.thu || (d ? getThu(d) : "");
      const start = x.start ?? "";
      const end = x.end ?? "";
      const hc = x.hc || 0;
      const tc = x.tc || 0;
      const bonus = x.bonus || 0;
      const total = x.total || (hc + tc + bonus);

      html += `
        <tr>
          <td>${thu}</td>
          <td>${d}</td>
          <td>${start}</td>
          <td>${end}</td>
          <td>${current}</td>
          <td>${hc.toLocaleString()}</td>
          <td>${tc.toLocaleString()}</td>
          <td>${bonus.toLocaleString()}</td>
          <td><b>${total.toLocaleString()}</b></td>
          <td><button class="danger" onclick="delDay(${i})">‚úñ</button></td>
        </tr>`;
      sHC += hc; sTC += tc; sB += bonus; sT += total;
    });

    document.getElementById("rows").innerHTML = html;
    document.getElementById("tHC").innerText = sHC.toLocaleString();
    document.getElementById("tTC").innerText = sTC.toLocaleString();
    document.getElementById("tB").innerText = sB.toLocaleString();
    document.getElementById("tSum").innerText = sT.toLocaleString();
  }

  function delDay(i){
    if (!current || !data.workers[current]) return;

    const tr = document.querySelectorAll("#rows tr")[i];
    if (tr){
      tr.classList.add("fade-out");
      setTimeout(()=>{
        data.workers[current].days.splice(i,1);
        save();
        loadWorker();
        showToast("üóëÔ∏è ƒê√£ xo√°");
      }, 220);
    } else {
      data.workers[current].days.splice(i,1);
      save();
      loadWorker();
      showToast("üóëÔ∏è ƒê√£ xo√°");
    }
  }

  // ========= History =========
  function renderHistory(){
    const tb = document.getElementById("history");
    const list = data.history || [];
    tb.innerHTML = list.map(h => `
      <tr>
        <td>${h.time}</td>
        <td>${(h.thu || getThu(h.date))} - ${h.date}</td>
        <td>${h.id}</td>
        <td>${h.name}</td>
        <td>${h.shift === "ngay" ? "Ca ng√†y" : "Ca ƒë√™m"}</td>
        <td>${h.start}</td>
        <td>${h.end}</td>
      </tr>
    `).join("");
  }

  // ========= Stat =========
  function statDay(){
    const d = document.getElementById("statDate").value;
    if (!d) return showToast("Ch·ªçn ng√†y");

    let hc=0, tc=0, b=0, sum=0;
    Object.values(data.workers).forEach(w => {
      (w.days||[]).forEach(x => {
        if (x.d === d){
          hc += (x.hc||0);
          tc += (x.tc||0);
          b  += (x.bonus||0);
          sum += (x.total||((x.hc||0)+(x.tc||0)+(x.bonus||0)));
        }
      });
    });

    document.getElementById("statTable").innerHTML = `
      <tr class="total">
        <td>Ng√†y: ${getThu(d)} - ${d}</td>
        <td>${hc.toLocaleString()}</td>
        <td>${tc.toLocaleString()}</td>
        <td>${b.toLocaleString()}</td>
        <td><b>${sum.toLocaleString()}</b></td>
      </tr>`;
    showToast("üìä ƒê√£ th·ªëng k√™ ng√†y");
  }

  function syncWeekRange(){
    const pick = document.getElementById("statWeekPick").value;
    const fromEl = document.getElementById("statWeekFrom");
    const toEl = document.getElementById("statWeekTo");
    if (!pick){ fromEl.value=""; toEl.value=""; return; }
    const r = getWeekRange(pick);
    fromEl.value = r.start;
    toEl.value = r.end;
  }

  function statWeek(){
    const pick = document.getElementById("statWeekPick").value;
    if (!pick) return showToast("Ch·ªçn ng√†y trong tu·∫ßn");

    const r = getWeekRange(pick);
    document.getElementById("statWeekFrom").value = r.start;
    document.getElementById("statWeekTo").value = r.end;

    let hc=0, tc=0, b=0, sum=0;
    Object.values(data.workers).forEach(w => {
      (w.days||[]).forEach(x => {
        if (x.d >= r.start && x.d <= r.end){
          hc += (x.hc||0);
          tc += (x.tc||0);
          b  += (x.bonus||0);
          sum += (x.total||((x.hc||0)+(x.tc||0)+(x.bonus||0)));
        }
      });
    });

    document.getElementById("statTable").innerHTML = `
      <tr class="total">
        <td>Tu·∫ßn: ${r.start} ‚Üí ${r.end}</td>
        <td>${hc.toLocaleString()}</td>
        <td>${tc.toLocaleString()}</td>
        <td>${b.toLocaleString()}</td>
        <td><b>${sum.toLocaleString()}</b></td>
      </tr>`;
    showToast("üìä ƒê√£ th·ªëng k√™ tu·∫ßn");
  }

  function syncMonthRange(){
    const pick = document.getElementById("statMonthPick").value;
    const fromEl = document.getElementById("statMonthFrom");
    const toEl = document.getElementById("statMonthTo");
    if (!pick){ fromEl.value=""; toEl.value=""; return; }
    const r = getMonthRange(pick);
    fromEl.value = r.start;
    toEl.value = r.end;
  }

  function statMonth(){
    const pick = document.getElementById("statMonthPick").value;
    if (!pick) return showToast("Ch·ªçn ng√†y trong th√°ng");

    const r = getMonthRange(pick);
    document.getElementById("statMonthFrom").value = r.start;
    document.getElementById("statMonthTo").value = r.end;

    let hc=0, tc=0, b=0, sum=0;
    Object.values(data.workers).forEach(w => {
      (w.days||[]).forEach(x => {
        if (x.d >= r.start && x.d <= r.end){
          hc += (x.hc||0);
          tc += (x.tc||0);
          b  += (x.bonus||0);
          sum += (x.total||((x.hc||0)+(x.tc||0)+(x.bonus||0)));
        }
      });
    });

    document.getElementById("statTable").innerHTML = `
      <tr class="total">
        <td>Th√°ng: ${r.start} ‚Üí ${r.end}</td>
        <td>${hc.toLocaleString()}</td>
        <td>${tc.toLocaleString()}</td>
        <td>${b.toLocaleString()}</td>
        <td><b>${sum.toLocaleString()}</b></td>
      </tr>`;
    showToast("üìä ƒê√£ th·ªëng k√™ th√°ng");
  }

  // ========= Init =========
  (function init(){
    const today = toISO(new Date());
    document.getElementById("date").value = today;

    document.getElementById("statDate").value = today;
    document.getElementById("statWeekPick").value = today;
    document.getElementById("statMonthPick").value = today;
    syncWeekRange();
    syncMonthRange();

    renderWorkerTabs();
    renderHistory();
  })();
</script>

</body>
</html>
